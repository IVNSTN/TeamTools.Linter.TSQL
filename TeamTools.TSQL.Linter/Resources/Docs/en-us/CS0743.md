

# Using non-invariant functions and subqueries inside CASE

|||
|-|-|
| Id | **CS0743**
| Mnemo | INVARIANT_CASE_ARG
| Severity | ℹ Hint
| Category | [CodeSmell](./Category_CodeSmell.md)
| Source code | [InvariantCaseArgumentRule.cs](../../../Rules/CodeSmell/InvariantCaseArgumentRule.cs)

## Cause

The rule is triggered if non-invariant (dependent) functions and subqueries are present in expressions based on CASE.
<p id="descr">Remove access to tables from subqueries or non-invariant functions.</p>

## Examples

Bad

```sql
SELECT NULLIF((SELECT TOP(1) id FROM dbo.foo), 0)

SELECT COALESCE(id, NEWID())
FROM dbo.foo;

SET @var = CASE
    WHEN RAND() > 0.5 THEN 2
    ELSE RAND()
END;
```

Good

```sql
SELECT COALESCE(id, 3)
FROM dbo.foo

SET @var = CASE
    WHEN GETDATE() > @today THEN 2
    ELSE 3
END
```

## Tips

💡 The CASE expression and those based on it actually evaluate the result of the calculation several times: first, the compiler needs to figure out what type the result will have; then it needs to calculate conditions and convert the result to the target data type. Therefore, functions with non-constant results (e.g., RAND()) can be executed more than once, and accordingly, the result of an entire CASE expression may be unstable due to changes in input values or calculated results. For the same reason, the use of subqueries that access permanent tables within CASE expressions is not recommended.

💡 The NULLIF function is not recommended for use with time-dependent functions like RAND(), as this may cause the function to be evaluated twice and return different results for each call.

## Links

[Statement CASE](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/case-transact-sql?view=sql-server-ver16)

[Function NULLIF](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/nullif-transact-sql?view=sql-server-ver16#remarks)
