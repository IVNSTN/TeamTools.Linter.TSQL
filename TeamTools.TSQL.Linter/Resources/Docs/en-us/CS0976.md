

# Dropping not owned table from outer scope is unsafe

|||
|-|-|
| Id | **CS0976**
| Mnemo | DROPPING_NOT_OWNED_TABLE
| Severity | ℹ Hint
| Category | [CodeSmell](./Category_CodeSmell.md)
| Source code | [DroppingOuterTempTableRule.cs](../../../Rules/CodeSmell/DroppingOuterTempTableRule.cs)

## Cause

The rule is triggered if the procedure deletes a temporary table that might have been created in the external scope.
<p id="descr">Remove the temporary table delete statement.</p>

## Examples

Bad

```sql
CREATE PROCEDURE dbo.my_proc
AS
BEGIN

    DROP TABLE IF EXISTS #tmp_table;
    CREATE TABLE #tmp_table(...);
...
```

Good

```sql
CREATE PROCEDURE dbo.my_proc
AS
BEGIN

    CREATE TABLE #tmp_table(...);
...
```

## Tips

💡

```sql
DROP TABLE IF EXISTS #tmp;
CREATE TABLE #tmp(...);
```

This code is only suitable for debugging and service scripts that are not executed in stored procedures. If you run this script again, an error may occur due to the existence of a table with the same name. Such scripts are not nested, and temporary objects are not cleaned up automatically as they would be when a stored procedure completes. Therefore, this code can be used safely. It is recommended to delete temporary tables at the end of these scripts. In a stored procedure or trigger, this code example physically cannot delete the "old" #tmp table left over from the last run. It can only delete tables created in the current viewport, as temporary tables are only available in the current scope. You don't need to delete a table before creating another one, as this may delete a different table with the same name created in an external scope. Moreover, such a DROP-CREATE is able to substitute the table for even more deeply nested batches. This is incorrect and confusing behavior, which will lead to problems that are extremely difficult to find. The presence of similar names in temporary objects can lead to confusion during the development and testing phases, which is why it's important to rename them. It should be noted that temporary tables can be accessed within nested scopes and should be named according to their purpose, rather than using generic names such as #tmp, #rows, or #data. After creating these tables, it is important to test them to ensure they work as intended. It is also important to be aware that deleting these tables may cause problems with code compatibility.

## Links

[Temporary tables](https://learn.microsoft.com/en-us/sql/t-sql/statements/create-table-transact-sql?view=sql-server-ver16#temporary-tables)
