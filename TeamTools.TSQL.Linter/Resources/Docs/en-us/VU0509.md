
# Unexpected dynamic SQL

|||
|-|-|
| Id | **VU0509**
| Mnemo | DYNAMIC_SQL
| Severity | ⚠ Warning
| Category | [Vulnerability](./Category_Vulnerability.md)
| Source code | [DynamicSqlRule.cs](../../../Rules/Vulnerability/DynamicSqlRule.cs)

## Cause

The rule is triggered when code contains dynamic queries like EXEC (@sql), EXEC @sp, sp_executesql, OPENQUERY.
<p id="descr">Use dynamic SQL only when absolutely necessary.</p>

## Examples

Bad

```sql
EXEC (@cmd);

EXEC @some_procedure;

EXEC sp_executesql 'command';

SELECT * FROM OPENQUERY (LNKSRV, 'select * from sys.columns');
```

Good

```sql
DECLARE @cmd NVARCHAR(2000) = N'SELECT * FROM dbo.test WHERE col_a = @par_a';

-- such code can only be contained in a service procedure in a specially designated scheme
EXEC sp_executesql
    @stmt = @cmd
    , @params = N'@par_a INT'
    , @par_a = 1;
```

## Tips

⚠️ Try to avoid dynamic SQL in modules available for call by users or external services.

💡 Dynamic SQL is dangerous both because it allows the vulnerability of sql injection, and because it is not analyzed by either the compiler or the linter. Thus it may contain invalid constructions.

💡 Be careful including the input parameters of the procedure in a dynamic query, perform special character escaping.

💡 It is advisable to pass external parameters as sp_executesql parameters if possible.

💡 Dynamic SQL can make sense in service procedures only which are not available to users.
