

# Неоднозначность при использовании INSERTED/DELETED в OUTPUT в триггере

|||
|-|-|
| Id | **AM0162**
| Мнемо | OUTPUT_IN_TRIGGER_AMBIGUOUS_INSDEL
| Серьёзность | ⚠ Предупреждение
| Категория | [Неоднозначность](./Категория_Неоднозначность.md), [Триггеры](./Группа_Триггеры.md)
| Исходный код | [ReferencingInsertedDeletedInOutputInTriggerRule.cs](../../../Rules/Ambiguity/ReferencingInsertedDeletedInOutputInTriggerRule.cs)

## Причина

Правило срабатывает, если в одном и том же запросе в триггере используется INSERTED/DELETED в инструкции OUTPUT и специальная таблицы INSERTED/DELETED в инструкции FROM.
<p id="descr">Удалите OUTPUT или укажите алиас для таблицы INSERTED/DELETED.</p>

## Примеры

Некорректно

```sql
-- somwhere in trigger
DELETE bk
OUTPUT DELETED.ID -- DELETED is alias for book_archive
INTO dbo.book_archive (ID)
FROM dbo.book AS bk
INNER JOIN DELETED
    ON bk.ID = DELETED.ID; -- DELETED is special table
```

Корректно

```sql
-- somwhere in trigger
DELETE bk
OUTPUT DELETED.ID
INTO dbo.book_archive (ID)
FROM dbo.book AS bk
INNER JOIN DELETED AS del
    ON bk.ID = del.ID;
```

## Подсказки

💡 Если INSERTED/DELETED используется в инструкции OUTPUT вместе с INSERTED/DELETED в инструкции FROM в запросе внутри триггера, то это приводит к дампам. По возможности избегайте использование инструкции OUTPUT внутри триггеров.

💡 Следует избегать такого кода, поскольку его довольно сложно читать.
