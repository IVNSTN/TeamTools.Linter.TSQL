

# Не задан код возврата после CATCH

|||
|-|-|
| Id | **CS0143**
| Мнемо | PROC_RETURN_REQUIRED_AFTER_CATCH
| Серьёзность | ⚠ Предупреждение
| Категория | [СомнительноеКодирование](./Категория_СомнительноеКодирование.md)
| Исходный код | [ReturnValueFromProcIfTryCatchUsedRule.cs](../../../Rules/CodeSmell/ReturnValueFromProcIfTryCatchUsedRule.cs)

## Причина

Правило срабатывает, если после блока `TRY...CATCH` нет явного `RETURN` с указанием кода возврата.
<p id="descr">Добавьте RETURN с указанием кода возврата после блока TRY-CATCH.</p>

## Примеры

Некорректно

```sql
CREATE PROCEDURE dbo.foo
AS
BEGIN
    BEGIN TRY
        SELECT 1;

        RETURN 0;
    END TRY
    BEGIN CATCH
        SELECT ERROR_MESSAGE();
    END CATCH;
END;
```

Корректно

```sql
ALTER PROCEDURE dbo.foo
AS
BEGIN
    BEGIN TRY
        SELECT 1;

        RETURN 0;
    END TRY
    BEGIN CATCH
        -- return in the catch
        RETURN 1;
    END CATCH;
END;
GO

ALTER PROCEDURE dbo.foo
AS
BEGIN
    BEGIN TRY
        SELECT 1;

        RETURN 0;
    END TRY
    BEGIN CATCH
        SELECT ERROR_MESSAGE();
    END CATCH;

    -- return after catch
    RETURN 0;
END;
```

## Подсказки

💡 Код возврата по умолчанию - ноль, но в случае обработки ошибки блоком `TRY...CATCH` неявное значение кода возврата может измениться. Т.е., если ошибка была и в `CATCH` её заглушили, но не сделали явно `RETURN 0`, то вызывающая сторона может получить код возврата отличный от нуля и воспринять это как нештатное завершение выполнения. После `CATCH` всегда делайте явный `RETURN <value>` с явно указанным кодом ошибки или успеха.

💡 Не срабатывает, если в `CATCH` есть `THROW` или `RAISERROR`.

💡 Не срабатывает, если за `BEGIN CATCH` есть `RETURN`. Неважно, где именно, лишь бы дальше по коду.

## Ссылки

[TRY...CATCH](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/try-catch-transact-sql?view=sql-server-ver16)
