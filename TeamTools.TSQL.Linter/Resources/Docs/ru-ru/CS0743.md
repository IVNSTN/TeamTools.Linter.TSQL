

# Использование неинвариантных функций и подзапросов внутри CASE

|||
|-|-|
| Id | **CS0743**
| Мнемо | INVARIANT_CASE_ARG
| Серьёзность | ℹ Подсказка
| Категория | [СомнительноеКодирование](./Категория_СомнительноеКодирование.md)
| Исходный код | [InvariantCaseArgumentRule.cs](../../../Rules/CodeSmell/InvariantCaseArgumentRule.cs)

## Причина

Правило срабатывает, если в выражениях, основанных на CASE, присутствуют неинвариантные (зависимые) функции и подзапросы.
<p id="descr">Уберите обращение к таблицам из подзапросов или неинвариантные функции.</p>

## Примеры

Некорректно

```sql
SELECT NULLIF((SELECT TOP(1) id FROM dbo.foo), 0)

SELECT COALESCE(id, NEWID())
FROM dbo.foo;

SET @var = CASE
    WHEN RAND() > 0.5 THEN 2
    ELSE RAND()
END;
```

Корректно

```sql
SELECT COALESCE(id, 3)
FROM dbo.foo

SET @var = CASE
    WHEN GETDATE() > @today THEN 2
    ELSE 3
END
```

## Подсказки

💡 Выражение CASE и основанные на нём фактически оценивают результат вычисления несколько раз: первый раз компилятору нужно разобраться, какой тип будет иметь результат, затем уже нужно просчитать условия и сконвертировать итог в целевой тип данных. Поэтому функции, имеющие непостоянный результат (например, RAND()), могут быть выполнены больше одного раза и, соответственно, результат всего выражения CASE может быть непостоянным из-за меняющихся входных значений предикатов или вычисленных результатов. По той же причине нежелательно присутствие в CASE-выражениях подзапросов, обращающихся к постоянным таблицам.

💡 Функции NULLIF не рекомендуется использовать такие зависимые от времени функции, как RAND(). Это может приводить к тому, что функция будет вычисляться дважды с возвратом различных результатов для каждого из вызовов.

## Ссылки

[Выражение CASE](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/case-transact-sql?view=sql-server-ver16)

[Функция NULLIF](https://learn.microsoft.com/ru-ru/sql/t-sql/language-elements/nullif-transact-sql?view=sql-server-ver16#remarks)
