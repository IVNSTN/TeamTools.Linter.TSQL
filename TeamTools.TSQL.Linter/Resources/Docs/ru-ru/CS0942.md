

# Рекурсивный запрос должен иметь ограничение глубины

|||
|-|-|
| Id | **CS0942**
| Мнемо | CTE_MAX_RECURSION
| Серьёзность | ℹ Подсказка
| Категория | [СомнительноеКодирование](./Категория_СомнительноеКодирование.md)
| Исходный код | [RecursiveCteMaxRecursionRule.cs](../../../Rules/CodeSmell/RecursiveCteMaxRecursionRule.cs)

## Причина

Правило срабатывает, если в рекурсивном запросе отсутствует ограничение на максимальное число рекурсий.
<p id="descr">Ограничьте количество разрешенных уровней рекурсии.</p>

## Примеры

Некорректно

```sql
;WITH CTE_recursive AS
(
...
)
SELECT C.Path, C.Level
FROM CTE AS C;
```

Корректно

```sql
;WITH CTE_recursive AS
(
...
)
SELECT C.Path, C.Level
FROM CTE AS C
OPTION (MAXRECURSION 10);
```

## Подсказки

💡 MAXRECURSION в SQL Server - это параметр, который устанавливает ограничение на количество уровней рекурсии, разрешённых для конкретной инструкции. Данная функция служит для предотвращения бесконечного цикла, который может возникнуть в результате неправильно составленного рекурсивного CTE-выражения.

💡 По умолчанию установлено значение MAXRECURSION равное 100. Однако, если вы планируете работу с ограниченным количеством уровней дерева, рекомендуется установить более конкретное значение, меньшее 100.

💡 Для деревьев с неограниченной или очень глубокой вложенностью рекурсия, возможно, не является оптимальным решением. Вместо этого стоит рассмотреть системный тип базы данных HIERARCHYID или его рукописный аналог, где хранится полный путь с разделителем.

## Ссылки

[Рекурсивные обобщенные табличные выражения](https://learn.microsoft.com/ru-ru/sql/t-sql/queries/with-common-table-expression-transact-sql?view=sql-server-ver16#guidelines-for-creating-and-using-common-table-expressions)

[Справочник по методам типа данных HIERARCHYID](https://learn.microsoft.com/ru-ru/sql/t-sql/data-types/hierarchyid-data-type-method-reference?view=sql-server-ver16)
