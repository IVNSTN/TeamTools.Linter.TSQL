

# Удаление таблицы, созданной во внешней области видимости, небезопасно

|||
|-|-|
| Id | **CS0976**
| Мнемо | DROPPING_NOT_OWNED_TABLE
| Серьёзность | ℹ Подсказка
| Категория | [СомнительноеКодирование](./Категория_СомнительноеКодирование.md)
| Исходный код | [DroppingOuterTempTableRule.cs](../../../Rules/CodeSmell/DroppingOuterTempTableRule.cs)

## Причина

Правило срабатывает, если в процедуре есть удаление временной таблицы, которая могла быть создана во внешней области.
<p id="descr">Уберите оператор удаления временной таблицы.</p>

## Примеры

Некорректно

```sql
CREATE PROCEDURE dbo.my_proc
AS
BEGIN

    DROP TABLE IF EXISTS #tmp_table;
    CREATE TABLE #tmp_table(...);
...
```

Корректно

```sql
CREATE PROCEDURE dbo.my_proc
AS
BEGIN

    CREATE TABLE #tmp_table(...);
...
```

## Подсказки

💡

```sql
DROP TABLE IF EXISTS #tmp;
CREATE TABLE #tmp(...);
```

Такой код подходит только для отладочных и служебных скриптов, которые не выполняются в хранимых процедурах. Если запустить такой скрипт повторно, возникнет ошибка из-за наличия одноимённой таблицы. Поскольку такие скрипты не являются вложенными и не происходит автоматическая очистка временных объектов, как это происходит при завершении хранимой процедуры, подобный код может быть использован. В этих скриптах также рекомендуется удалять временные таблицы в конце. В теле хранимой процедуры или триггера приведенный пример кода физически не способен удалить «старую» таблицу #tmp, оставшуюся от прошлого запуска. Он может удалить только таблицу, созданную во внешней области видимости, т.к. в текущей области видимости эти временные таблицы доступны. Не нужно удалять таблицу перед её созданием, это может привести к удалению таблицы с таким же именем, созданной во внешней области видимости. Более того, подобный DROP-CREATE способен подменить объект для еще более глубоко вложенных батчей. Это некорректное и запутанное поведение, которое приведет к проблемам, диагностировать которые будет чрезвычайно тяжело. Наличие пересечений в именах временных объектов - повод для переименования на этапе разработки и отладки. Нужно помнить, что временные таблицы видны во вложенных областях видимости, и именовать их по смыслу, а не #tmp, #rows, #data. Потом нужно тестировать. Также важно знать, что удаление этих таблиц может вызвать проблемы с совместимостью кода.

## Ссылки

[Временные таблицы](https://learn.microsoft.com/ru-ru/sql/t-sql/statements/create-table-transact-sql?view=sql-server-ver16#temporary-tables)
