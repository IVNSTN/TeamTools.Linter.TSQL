
# Столбец не включен в GROUP BY или агрегатную функцию

|||
|-|-|
| Id | **FA0949**
| Мнемо | COLUMN_NOT_IN_GROUP_BY
| Серьёзность | ⚠ Предупреждение
| Категория | [Сбой](./Категория_Сбой.md)
| Исходный код | [ColumnNotIncludedInGroupByRule.cs](../../../Rules/Failure/ColumnNotIncludedInGroupByRule.cs)

## Причина

Правило срабатывает, если столбец выборки не участвует в определении GROUP BY, и над ней не выполняется агрегация.
<p id="descr">Укажите неагрегированные столбцы запроса в GROUP BY.</p>

## Примеры

Некорректно

```sql
SELECT SUM(Amount) total_amount, col1, col2
FROM dbo.Orders
GROUP BY col1
```

Корректно

```sql
SELECT SUM(Amount) total_amount, col1, col2
FROM dbo.Orders
GROUP BY col1, col2
```

## Подсказки

💡 Правило не срабатывает на выражения с вычислениями и преобразованиями, если в `GROUP BY` есть такое же выражение целиком. Но только если оно написано идентичным образом, т.е. там такие же алиасы, столько же скобок, операторы в том же порядке. С различием в незначащих пробелах справится, с остальным пока нет.

💡 `GROUP BY` работать по алиасам вычисляемых столбцов из `SELECT`, как это делает `ORDER BY`, не умеет. Чтобы уменьшить объемы одинакового кода, можно переложить вычисления в `CROSS` или `OUTER APPLY` без `FROM` и далее в `GROUP BY` и `SELECT` уже пользоваться именами столбцов из этого `APPLY`.

## Ссылки

[Агрегатные функции](https://learn.microsoft.com/ru-ru/sql/t-sql/functions/aggregate-functions-transact-sql?view=sql-server-ver16)

[SELECT — GROUP BY](https://learn.microsoft.com/ru-ru/sql/t-sql/queries/select-group-by-transact-sql?view=sql-server-ver16)
