
# Курсор, объявленный для изменения столбца, доступного только для чтения

|||
|-|-|
| Id | **FA0981**
| Мнемо | CURSOR_MODIFIES_READONLY_COL
| Серьёзность | ⚠ Предупреждение
| Категория | [Сбой](./Категория_Сбой.md)
| Исходный код | [CursorForUpdateReadonlyColumnRule.cs](../../../Rules/Failure/CursorForUpdateReadonlyColumnRule.cs)

## Причина

Правило срабатывает, если обнаружена попытка изменить с помощью курсора значение столбца, доступного только для чтения.
<p id="descr">Для модификации укажите невычисляемый столбец.</p>

## Примеры

Некорректно

```sql
CREATE TABLE dbo.Product
(
    ProductId     INT          IDENTITY(1, 1) NOT NULL
    , ProductName VARCHAR(100) NOT NULL
    , ProductType VARCHAR(100) NOT NULL
    , Quantity    SMALLINT     NULL
    , Price       MONEY        NULL
    , Summa       AS (Quantity * Price) PERSISTED
);

DECLARE update_cursor CURSOR FOR
    SELECT ProductId, Summa FROM dbo.Product WHERE ProductType = 'example';

OPEN update_cursor;

FETCH FROM update_cursor;

WHILE @@FETCH_STATUS = 0
BEGIN
    UPDATE dbo.Product SET Summa = 100 WHERE CURRENT OF update_cursor;

    FETCH NEXT FROM update_cursor;
END;
```

Корректно

```sql
CREATE TABLE dbo.Product
(
    ProductId     INT          IDENTITY(1, 1) NOT NULL
    , ProductName VARCHAR(100) NOT NULL
    , ProductType VARCHAR(100) NOT NULL
    , Quantity    SMALLINT     NULL
    , Price       MONEY        NULL
    , Summa       MONEY        NULL
);

DECLARE update_cursor CURSOR FOR
    SELECT ProductId, Price, Quantity FROM dbo.Product WHERE ProductType = 'example';

OPEN update_cursor;

FETCH FROM update_cursor;

WHILE @@FETCH_STATUS = 0
BEGIN
    UPDATE dbo.Product SET Summa = (Price * Quantity) WHERE CURRENT OF update_cursor;

    FETCH NEXT FROM update_cursor;
END;
```

## Подсказки

💡 Вычисляемый столбец не может быть целевым столбцом инструкций INSERT или UPDATE.

## Ссылки

[Указание вычисляемых столбцов в таблице](https://learn.microsoft.com/ru-ru/sql/relational-databases/tables/specify-computed-columns-in-a-table?view=sql-server-ver16)
