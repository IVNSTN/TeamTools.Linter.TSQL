

# CTE использовано несколько раз

|||
|-|-|
| Id | **PF0933**
| Мнемо | CTE_MULTIPLE_CALLS
| Серьёзность | ℹ Подсказка
| Категория | [Производительность](./Категория_Производительность.md)
| Исходный код | [MultipleJoinsToCteRule.cs](../../../Rules/Performance/MultipleJoinsToCteRule.cs)

## Причина

<p id="descr">Несколько упоминаний CTE приведут к его выполнению несколько раз, что может негативно повлиять на производительность.</p>

## Примеры

Некорректно

```sql
;WITH cte AS (SELECT 1 AS id)
UPDATE tb
SET id = ct.id + 1
FROM dbo.foo AS tb
INNER JOIN cte AS ct -- здесь
    ON ct.id = b.id
LEFT JOIN dbo.bar AS bb
    ON bb.title = tb.title
OUTER APPLY (SELECT TOP (1) id FROM cte WHERE cte.id > bb.id ORDER BY id) AS cc -- здесь
WHERE NOT EXISTS (SELECT 1 FROM cte AS ccc WHERE ccc < ct.id); -- здесь
```

Корректно

```sql
;WITH cte AS (SELECT 1 AS id)
UPDATE ct SET
    id = ct.id + 1
FROM dbo.foo AS tf
LEFT JOIN cte AS ct
    ON ct.id = tf.id
```

## Подсказки

💡 Если избыточная нагрузка присутствует, то может помочь перенос данных во временную таблицу и замена CTE на эту временную таблицу. Однако учитывайте потенциальный объем данных, который может в неё попасть.
