

# Неожидаемый динамический запрос

|||
|-|-|
| Id | **VU0509**
| Мнемо | DYNAMIC_SQL
| Серьёзность | ⚠ Предупреждение
| Категория | [Уязвимость](./Категория_Уязвимость.md)
| Исходный код | [DynamicSqlRule.cs](../../../Rules/Vulnerability/DynamicSqlRule.cs)

## Причина

Правило срабатывает при обнаружении динамических конструкций таких, как EXEC (@sql), EXEC @sp, sp_executesql, OPENQUERY.
<p id="descr">Используйте динамический SQL только при крайней необходимости.</p>

## Примеры

Некорректно

```sql
EXEC (@cmd);

EXEC @some_procedure;

EXEC sp_executesql 'command';

SELECT * FROM OPENQUERY (LNKSRV, 'select * from sys.columns');
```

Корректно

```sql
DECLARE @cmd NVARCHAR(2000) = N'SELECT * FROM dbo.test WHERE col_a = @par_a';

-- подобный код может содержаться только в служебной процедуре в специально выделенной для этого схеме
EXEC sp_executesql
    @stmt = @cmd
    , @params = N'@par_a INT'
    , @par_a = 1;
```

## Подсказки

⚠️ В пользовательских модулях, доступных для вызова конечными пользователями или внешними сервисами, появление динамических запросов следует избегать.

💡 Динамический SQL опасен и тем, что допускает внедрение SQL кода (SQL injection), и тем, что не анализируется ни компилятором, ни линтером, т.е. может содержать недопустимые и ошибочные конструкции.

💡 При включении в динамический запрос входных параметров процедуры проявляйте повышенную бдительность, выполняйте экранирование спецсимволов.

💡 Внешние параметры рекомендуется передавать в качестве параметров sp_executesql.

💡 Конструирование динамических запросов из параметров может быть оправдано только в служебных процедурах, которые недоступны для выполнения конечным пользователям продукта.
