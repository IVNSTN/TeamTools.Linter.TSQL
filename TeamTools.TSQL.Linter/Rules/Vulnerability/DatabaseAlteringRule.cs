using Microsoft.SqlServer.TransactSql.ScriptDom;
using System;
using System.Collections.Generic;
using TeamTools.Common.Linting;
using TeamTools.TSQL.Linter.Routines;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0501", "DATABASE_ALTERING")]
    internal sealed class DatabaseAlteringRule : AbstractRule
    {
        private static readonly Lazy<ICollection<string>> ForbiddenProcsInstance
            = new Lazy<ICollection<string>>(() => InitForbiddenProcsInstance(), true);

        public DatabaseAlteringRule() : base()
        {
        }

        private static ICollection<string> ForbiddenProcs => ForbiddenProcsInstance.Value;

        public override void Visit(TSqlScript node)
        {
            var procVisitor = new ForbiddenProcCallVisitor(HandleNodeError, ForbiddenProcs);
            node.AcceptChildren(procVisitor);
        }

        public override void Visit(ProcedureStatementBody node) => ValidateProgrammability(node);

        public override void Visit(TriggerStatementBody node) => ValidateProgrammability(node);

        public override void Visit(AlterDatabaseStatement node)
        {
            if (node is AlterDatabaseAddFileGroupStatement)
            {
                // add filegroup statements are fine as standalone scripts
                return;
            }

            HandleNodeError(node);
        }

        public override void Visit(CreateDatabaseStatement node) => HandleNodeError(node);

        public override void Visit(DropDatabaseStatement node) => HandleNodeError(node);

        public override void Visit(AlterServerConfigurationStatement node) => HandleNodeError(node);

        public override void Visit(BackupStatement node) => HandleNodeError(node);

        public override void Visit(RestoreStatement node) => HandleNodeError(node);

        public override void Visit(ShutdownStatement node) => HandleNodeError(node);

        public override void Visit(ReconfigureStatement node) => HandleNodeError(node);

        public override void Visit(CheckpointStatement node) => HandleNodeError(node);

        private static ICollection<string> InitForbiddenProcsInstance()
        {
            // TODO : consolidate all the metadata about known built-in functions
            return new SortedSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                "sp_addserver",
                "sp_dropserver",
                "sp_attachdb",
                "sp_renamedb",
                "sp_detachdb",
                "sp_changedbowner",
                "sp_configure",
                "sp_xp_cmd_shell_proxy_account",
            };
        }

        // no altering from programmabilities
        private void ValidateProgrammability(TSqlFragment node)
            => node.Accept(new AlterDatabaseVisitor(HandleNodeError));

        private class AlterDatabaseVisitor : VisitorWithCallback
        {
            public AlterDatabaseVisitor(Action<TSqlFragment> callback) : base(callback)
            { }

            public override void Visit(AlterDatabaseStatement node) => Callback(node);
        }
    }
}
