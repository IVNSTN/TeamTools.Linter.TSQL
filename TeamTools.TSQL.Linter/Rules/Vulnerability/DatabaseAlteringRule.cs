using Microsoft.SqlServer.TransactSql.ScriptDom;
using System;
using System.Collections.Generic;
using TeamTools.Common.Linting;
using TeamTools.TSQL.Linter.Routines;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0501", "DATABASE_ALTERING")]
    internal sealed class DatabaseAlteringRule : AbstractRule
    {
        // TODO : consolidate all the metadata about known built-in functions
        private static readonly HashSet<string> ForbiddenProcs = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "sp_addserver",
            "sp_attachdb",
            "sp_changedbowner",
            "sp_configure",
            "sp_detachdb",
            "sp_dropserver",
            "sp_renamedb",
            "sp_xp_cmd_shell_proxy_account",
        };

        private readonly AlterDatabaseVisitor alterDbVisitor;

        public DatabaseAlteringRule() : base()
        {
            alterDbVisitor = new AlterDatabaseVisitor(ViolationHandler);
        }

        public override void Visit(ProcedureStatementBody node) => ValidateProgrammability(node.StatementList);

        public override void Visit(TriggerStatementBody node) => ValidateProgrammability(node.StatementList);

        public override void Visit(AlterDatabaseStatement node)
        {
            if (node is AlterDatabaseAddFileGroupStatement)
            {
                // add filegroup statements are fine as standalone scripts
                return;
            }

            HandleNodeError(node);
        }

        public override void Visit(CreateDatabaseStatement node) => HandleNodeError(node);

        public override void Visit(DropDatabaseStatement node) => HandleNodeError(node);

        public override void Visit(AlterServerConfigurationStatement node) => HandleNodeError(node);

        public override void Visit(BackupStatement node) => HandleNodeError(node);

        public override void Visit(RestoreStatement node) => HandleNodeError(node);

        public override void Visit(ShutdownStatement node) => HandleNodeError(node);

        public override void Visit(ReconfigureStatement node) => HandleNodeError(node);

        public override void Visit(CheckpointStatement node) => HandleNodeError(node);

        public override void Visit(ExecutableProcedureReference node)
        {
            if (node.ProcedureReference.ProcedureVariable != null)
            {
                return;
            }

            string procName = node.ProcedureReference.ProcedureReference.Name.BaseIdentifier.Value;

            if (ForbiddenProcs.Contains(procName))
            {
                HandleNodeError(node, procName);
            }
        }

        // no altering from programmabilities
        private void ValidateProgrammability(TSqlFragment node) => node?.AcceptChildren(alterDbVisitor);

        private sealed class AlterDatabaseVisitor : VisitorWithCallback
        {
            public AlterDatabaseVisitor(Action<TSqlFragment> callback) : base(callback)
            { }

            public override void Visit(AlterDatabaseStatement node) => Callback(node);
        }
    }
}
