using Microsoft.SqlServer.TransactSql.ScriptDom;
using System;
using TeamTools.Common.Linting;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0509", "DYNAMIC_SQL")]
    internal sealed class DynamicSqlRule : AbstractRule
    {
        private const string ProcName = "sp_executesql";

        public DynamicSqlRule() : base()
        {
        }

        public override void Visit(ExecuteStatement node)
        {
            // The other method is responsible for ExecutableProcedureReference
            // if there is something else then this is an ad hoc
            if (node.ExecuteSpecification.ExecutableEntity is null
            || !(node.ExecuteSpecification.ExecutableEntity is ExecutableProcedureReference))
            {
                HandleNodeError(node, "ad hoc");
            }
        }

        public override void Visit(ExecutableProcedureReference node)
        {
            if (node.ProcedureReference.ProcedureVariable != null)
            {
                // EXEC @proc_name
                HandleNodeError(node, node.ProcedureReference.ProcedureVariable.Name);
            }
            else if (string.Equals(ProcName, node.ProcedureReference.ProcedureReference.Name.BaseIdentifier.Value, StringComparison.OrdinalIgnoreCase))
            {
                // EXEC sp_executesql
                HandleNodeError(node, ProcName);
            }
        }

        public override void Visit(OpenQueryTableReference node)
            => HandleNodeError(node, "OPENQUERY");
    }
}
