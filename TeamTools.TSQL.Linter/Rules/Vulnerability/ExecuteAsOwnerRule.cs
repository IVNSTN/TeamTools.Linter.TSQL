using Microsoft.SqlServer.TransactSql.ScriptDom;
using TeamTools.Common.Linting;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0518", "EXECUTE_AS_OWNER")]
    [SecurityRule]
    internal sealed class ExecuteAsOwnerRule : AbstractRule
    {
        public ExecuteAsOwnerRule() : base()
        {
        }

        protected override void ValidateBatch(TSqlBatch batch)
        {
            // CREATE PROC/TRIGGER/FUNC must be the first statement in a batch
            var firstStmt = batch.Statements[0];
            if (firstStmt is ProcedureStatementBody proc)
            {
                DoValidate(proc);
            }
            else if (firstStmt is TriggerStatementBody trg)
            {
                DoValidate(trg);
            }
        }

        private void DoValidate(ProcedureStatementBody node)
        {
            ExecuteAsProcedureOption executeAs = null;

            int n = node.Options.Count;
            for (int i = 0; i < n; i++)
            {
                var opt = node.Options[i];
                if (opt.OptionKind == ProcedureOptionKind.NativeCompilation)
                {
                    return;
                }
                else if (opt is ExecuteAsProcedureOption e)
                {
                    executeAs = e;
                }
            }

            if (executeAs is null)
            {
                return;
            }

            ValidateExecuteContext(executeAs.ExecuteAs);
        }

        private void DoValidate(TriggerStatementBody node)
        {
            ExecuteAsTriggerOption executeAs = null;

            int n = node.Options.Count;
            for (int i = 0; i < n; i++)
            {
                var opt = node.Options[i];
                if (opt.OptionKind == TriggerOptionKind.NativeCompile)
                {
                    return;
                }
                else if (opt is ExecuteAsTriggerOption e)
                {
                    executeAs = e;
                }
            }

            if (executeAs is null)
            {
                return;
            }

            ValidateExecuteContext(executeAs.ExecuteAsClause);
        }

        private void ValidateExecuteContext(ExecuteAsClause node)
        {
            if (node.ExecuteAsOption == ExecuteAsOption.Owner)
            {
                HandleNodeError(node);
            }
        }
    }
}
