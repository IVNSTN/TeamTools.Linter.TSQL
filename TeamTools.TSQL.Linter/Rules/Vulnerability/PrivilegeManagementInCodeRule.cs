using Microsoft.SqlServer.TransactSql.ScriptDom;
using System;
using System.Collections.Generic;
using TeamTools.Common.Linting;
using TeamTools.TSQL.Linter.Routines;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0512", "PRIVILEGE_MANAGEMENT")]
    [SecurityRule]
    internal sealed class PrivilegeManagementInCodeRule : AbstractRule
    {
        private static readonly HashSet<string> ForbiddenProcs;

        private readonly PrivManagementVisitor grant;

        // TODO : consolidate all the metadata about known built-in functions
        static PrivilegeManagementInCodeRule()
        {
            ForbiddenProcs = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                // participant management
                "sp_addapprole",
                "sp_addlogin",
                "sp_addremotelogin",
                "sp_addrole",
                "sp_addrolemember",
                "sp_addsrvrolemember",
                "sp_adduser",
                "sp_change_users_login",
                "sp_defaultdb",
                "sp_defaultlanguage",
                "sp_dropapprole",
                "sp_droplogin",
                "sp_dropremotelogin",
                "sp_droprole",
                "sp_droprolemember",
                "sp_dropsrvrolemember",
                "sp_dropuser",
                "sp_unsetapprole",
                "xp_grantlogin",
                "xp_logininfo",
                "xp_revokelogin",

                // privilege management
                "sp_approlepassword",
                "sp_grantdbaccess",
                "sp_grantlogin",
                "sp_password",
                "sp_revokedbaccess",
                "sp_revokelogin",
            };
        }

        public PrivilegeManagementInCodeRule() : base()
        {
            grant = new PrivManagementVisitor(ViolationHandler, ForbiddenProcs);
        }

        protected override void ValidateBatch(TSqlBatch batch)
        {
            // CREATE PROC must be the first statement in a batch
            var firstStmt = batch.Statements[0];
            if (firstStmt is ProcedureStatementBody proc)
            {
                DoValidate(proc.StatementList);
            }
            else if (firstStmt is TriggerStatementBody trg)
            {
                DoValidate(trg.StatementList);
            }
        }

        private void DoValidate(StatementList node) => node?.AcceptChildren(grant);

        private sealed class PrivManagementVisitor : ForbiddenProcCallVisitor
        {
            public PrivManagementVisitor(Action<TSqlFragment> callback, HashSet<string> procList) : base(callback, procList)
            {
            }

            public override void Visit(GrantStatement node) => Callback(node);

            public override void Visit(DenyStatement node) => Callback(node);

            public override void Visit(RevokeStatement node) => Callback(node);

            public override void Visit(CreateUserStatement node) => Callback(node);

            public override void Visit(DropUserStatement node) => Callback(node);

            public override void Visit(AlterUserStatement node) => Callback(node);

            public override void Visit(CreateLoginStatement node) => Callback(node);

            public override void Visit(DropLoginStatement node) => Callback(node);

            public override void Visit(AlterLoginAddDropCredentialStatement node) => Callback(node);

            public override void Visit(AlterLoginEnableDisableStatement node) => Callback(node);

            public override void Visit(AlterLoginOptionsStatement node) => Callback(node);

            public override void Visit(CreateSchemaStatement node) => Callback(node);

            public override void Visit(DropSchemaStatement node) => Callback(node);

            public override void Visit(AlterSchemaStatement node) => Callback(node);

            public override void Visit(CreateRoleStatement node) => Callback(node);

            public override void Visit(DropRoleStatement node) => Callback(node);

            public override void Visit(AlterRoleStatement node) => Callback(node);
        }
    }
}
