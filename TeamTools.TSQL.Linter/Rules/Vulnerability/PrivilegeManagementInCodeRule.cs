using Microsoft.SqlServer.TransactSql.ScriptDom;
using System;
using System.Collections.Generic;
using TeamTools.Common.Linting;
using TeamTools.TSQL.Linter.Routines;

namespace TeamTools.TSQL.Linter.Rules
{
    [RuleIdentity("VU0512", "PRIVILEGE_MANAGEMENT")]
    [SecurityRule]
    internal sealed class PrivilegeManagementInCodeRule : AbstractRule
    {
        private static readonly ICollection<string> ForbiddenParticipantProcs;

        private static readonly ICollection<string> ForbiddenGrantProcs;

        // TODO : consolidate all the metadata about known built-in functions
        static PrivilegeManagementInCodeRule()
        {
            ForbiddenParticipantProcs = new SortedSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                "xp_grantlogin",
                "xp_revokelogin",
                "xp_logininfo",
                "sp_addlogin",
                "sp_addremotelogin",
                "sp_adduser",
                "sp_addapprole",
                "sp_addrolemember",
                "sp_addsrvrolemember",
                "sp_addrole",
                "sp_droplogin",
                "sp_dropremotelogin",
                "sp_dropuser",
                "sp_dropapprole",
                "sp_droprolemember",
                "sp_dropsrvrolemember",
                "sp_droprole",
                "sp_unsetapprole",
                "sp_change_users_login",
                "sp_defaultdb",
                "sp_defaultlanguage",
            };

            ForbiddenGrantProcs = new SortedSet<string>(StringComparer.OrdinalIgnoreCase)
            {
                "sp_grantlogin",
                "sp_revokelogin",
                "sp_grantdbaccess",
                "sp_revokedbaccess",
                "sp_password",
                "sp_approlepassword",
            };
        }

        public PrivilegeManagementInCodeRule() : base()
        {
        }

        public override void Visit(ProcedureStatementBody node) => DetectPrivilegeManagement(node);

        public override void Visit(TriggerStatementBody node) => DetectPrivilegeManagement(node);

        private void DetectPrivilegeManagement(TSqlFragment node)
        {
            node.AcceptChildren(new GrantManagementVisitor(ForbiddenGrantProcs, HandleNodeError));

            node.AcceptChildren(new ParticipantManagementVisitor(ForbiddenParticipantProcs, HandleNodeError));
        }

        private class GrantManagementVisitor : TSqlFragmentVisitor
        {
            private readonly Action<TSqlFragment> callback;
            private readonly ICollection<string> forbiddenProcs;

            public GrantManagementVisitor(ICollection<string> forbiddenProcs, Action<TSqlFragment> callback)
            {
                this.forbiddenProcs = forbiddenProcs;
                this.callback = callback;
            }

            public override void Visit(ExecutableProcedureReference node)
            {
                var procVisitor = new ForbiddenProcCallVisitor(callback, forbiddenProcs);
                node.Accept(procVisitor);
            }

            public override void Visit(GrantStatement node) => callback(node);

            public override void Visit(DenyStatement node) => callback(node);

            public override void Visit(RevokeStatement node) => callback(node);
        }

        private class ParticipantManagementVisitor : TSqlFragmentVisitor
        {
            private readonly ICollection<string> forbiddenProcs;
            private readonly Action<TSqlFragment> callback;

            public ParticipantManagementVisitor(ICollection<string> forbiddenProcs, Action<TSqlFragment> callback)
            {
                this.forbiddenProcs = forbiddenProcs;
                this.callback = callback;
            }

            public ParticipantManagementVisitor(Action<TSqlFragment> callback)
            {
                this.callback = callback;
            }

            public override void Visit(ExecutableProcedureReference node)
            {
                var procVisitor = new ForbiddenProcCallVisitor(callback, forbiddenProcs);
                node.Accept(procVisitor);
            }

            public override void Visit(CreateUserStatement node) => callback(node);

            public override void Visit(DropUserStatement node) => callback(node);

            public override void Visit(AlterUserStatement node) => callback(node);

            public override void Visit(CreateLoginStatement node) => callback(node);

            public override void Visit(DropLoginStatement node) => callback(node);

            public override void Visit(AlterLoginStatement node) => callback(node);

            public override void Visit(CreateSchemaStatement node) => callback(node);

            public override void Visit(DropSchemaStatement node) => callback(node);

            public override void Visit(AlterSchemaStatement node) => callback(node);

            public override void Visit(CreateRoleStatement node) => callback(node);

            public override void Visit(DropRoleStatement node) => callback(node);

            public override void Visit(AlterRoleStatement node) => callback(node);
        }
    }
}
